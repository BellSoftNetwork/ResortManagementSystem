# 스테이징 환경 Deployment 패치
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-core
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: api-core
        env:
        - name: API_PROFILE
          value: "staging"
        - name: LOG_LEVEL
          value: "debug"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-legacy
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: api-legacy
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "staging"
        - name: JAVA_OPTS
          value: "-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-web
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: frontend-web
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
---
# 스테이징용 Ingress 패치
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: resort-management-system
  annotations:
    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:ap-northeast-2:ACCOUNT:certificate/STAGING-CERT-ID"
    nginx.ingress.kubernetes.io/rate-limit: "500"
    nginx.ingress.kubernetes.io/rate-limit-rps: "50"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://staging-resort.bellsoft.net,http://localhost:9000"
spec:
  tls:
    - hosts:
        - staging-resort.bellsoft.net
      secretName: resort-staging-tls-secret
  rules:
    - host: staging-resort.bellsoft.net
      http:
        paths:
          - path: /api/v1
            pathType: Prefix
            backend:
              service:
                name: api-core
                port:
                  number: 8080
          - path: /api/legacy
            pathType: Prefix
            backend:
              service:
                name: api-legacy
                port:
                  number: 8080
          - path: /actuator
            pathType: Prefix
            backend:
              service:
                name: api-legacy
                port:
                  number: 8080
          - path: /docs
            pathType: Prefix
            backend:
              service:
                name: api-core
                port:
                  number: 8080
          - path: /health
            pathType: Exact
            backend:
              service:
                name: api-core
                port:
                  number: 8080
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-web
                port:
                  number: 80