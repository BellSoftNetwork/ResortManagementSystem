apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: resort-management-system
  annotations:
    # AWS Load Balancer Controller 설정
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:ap-northeast-2:ACCOUNT:certificate/CERT-ID"
    
    # 보안 헤더
    alb.ingress.kubernetes.io/actions.ssl-redirect: |
      {
        "Type": "redirect",
        "RedirectConfig": {
          "Protocol": "HTTPS",
          "Port": "443",
          "StatusCode": "HTTP_301"
        }
      }
    
    # CORS 및 보안 헤더 설정
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "PUT, GET, POST, OPTIONS, DELETE, PATCH"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Accept, Authorization, Content-Type, X-Requested-With"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-rps: "10"
    
    # 타임아웃 설정
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    
    # 업로드 크기 제한
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  tls:
    - hosts:
        - resort.example.com  # 실제 도메인으로 교체 필요
      secretName: resort-tls-secret
  rules:
    - host: resort.example.com  # 실제 도메인으로 교체 필요
      http:
        paths:
          # API 라우팅 (api-core 우선)
          - path: /api/v1
            pathType: Prefix
            backend:
              service:
                name: api-core
                port:
                  number: 8080
          
          # 레거시 API 라우팅 (특정 엔드포인트만)
          - path: /api/legacy
            pathType: Prefix
            backend:
              service:
                name: api-legacy
                port:
                  number: 8080
          
          # Actuator 엔드포인트 (레거시에서만 제공)
          - path: /actuator
            pathType: Prefix
            backend:
              service:
                name: api-legacy
                port:
                  number: 8080
          
          # 문서화 엔드포인트
          - path: /docs
            pathType: Prefix
            backend:
              service:
                name: api-core
                port:
                  number: 8080
          
          # 헬스체크 (api-core 우선)
          - path: /health
            pathType: Exact
            backend:
              service:
                name: api-core
                port:
                  number: 8080
          
          # 프론트엔드 (나머지 모든 경로)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-web
                port:
                  number: 80