# GitOps Î∞∞Ìè¨Î•º ÏúÑÌïú Í≥µÌÜµ ÏÑ§Ï†ï
.gitops-deploy:
  stage: deploy
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/alpine/k8s:1.33.4
  before_script:
    # Verify tools are available
    - |
      echo "üîß Verifying GitOps tools..."
      git --version
      kubectl version --client
      kustomize version
      jq --version
      yq --version
  script:
    # Ï¥àÍ∏∞Ìôî Î∞è ÏÑ§Ï†ï
    - |
      echo "üöÄ Starting GitOps deployment for ${GITOPS_ENVIRONMENT} environment"
      echo "üì¶ App ${APP_NAME} | üè∑Ô∏è Tag ${NEW_IMAGE_TAG}"
      GITOPS_REPO_URL="https://deploy:${GITOPS_DEPLOY_TOKEN}@gitlab.bellsoft.net/devops/bsn-gitops.git"

    # GitOps Ï†ÄÏû•ÏÜå ÌÅ¥Î°† Î∞è ÏÑ§Ï†ï
    - |
      git clone "${GITOPS_REPO_URL}" gitops-repo
      cd gitops-repo
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@bellsoft.net}"
      git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"

    # kustomization.yaml Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏
    - |
      cd "${GITOPS_KUSTOMIZE_PATH}"
      echo "üìÅ Current directory: $(pwd)"
      echo "üìã Files in directory: $(ls -la)"
      kustomize edit set image ${APP_NAME}=${CI_REGISTRY_IMAGE}/${APP_NAME}:${NEW_IMAGE_TAG}

    # Git Ïª§Î∞ã Ï§ÄÎπÑ
    - |
      cd ${CI_PROJECT_DIR}/gitops-repo
      git add "${GITOPS_KUSTOMIZE_PATH}/kustomization.yaml"
      git commit -m "Deploy ${APP_NAME} to ${GITOPS_ENVIRONMENT} ${CI_COMMIT_BRANCH}@${CI_COMMIT_SHORT_SHA}"

    # Git push with retry logic
    - |
      MAX_RETRIES=5
      RETRY_COUNT=0
      RETRY_DELAY=2

      echo "üì§ Attempting to push changes to GitOps repository..."

      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        echo "üîÑ Push attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"

        if git push origin main; then
          echo "‚úÖ Push successful!"
          break
        fi

        RETRY_COUNT=$((RETRY_COUNT + 1))

        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "‚ùå Failed to push after $MAX_RETRIES attempts"
          git fetch origin main
          git log --oneline origin/main -5
          exit 1
        fi

        echo "‚ö†Ô∏è Push failed, retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY

        git fetch origin main
        if ! git rebase origin/main; then
          echo "‚ö†Ô∏è Rebase conflict, reapplying changes..."
          git rebase --abort 2>/dev/null || true
          git reset --hard origin/main
          cd "${GITOPS_KUSTOMIZE_PATH}"
          kustomize edit set image ${APP_NAME}=${CI_REGISTRY_IMAGE}/${APP_NAME}:${NEW_IMAGE_TAG}
          cd ${CI_PROJECT_DIR}/gitops-repo
          git add "${GITOPS_KUSTOMIZE_PATH}/kustomization.yaml"
          git commit -m "Deploy ${APP_NAME} to ${GITOPS_ENVIRONMENT} ${CI_COMMIT_BRANCH}@${CI_COMMIT_SHORT_SHA} (retry $RETRY_COUNT)"
        fi

        RETRY_DELAY=$((RETRY_DELAY * 2))
      done

      echo "‚úÖ GitOps deployment triggered successfully!"
  interruptible: false
  rules:
    - if: "$TEST_DISABLED || $BUILD_DISABLED || $DEPLOY_DISABLED"
      when: never

# api-core Î∞∞Ìè¨Ïö© Î≥ÄÍ≤Ω Í∞êÏßÄ Í∑úÏπô
.api-core-changes: &api-core-changes
  - apps/api-core/**/*
  - .gitlab-ci.yml
  - .gitlab/ci/apps/api-core.gitlab-ci.yaml

# frontend-web Î∞∞Ìè¨Ïö© Î≥ÄÍ≤Ω Í∞êÏßÄ Í∑úÏπô
.frontend-changes: &frontend-changes
  - apps/frontend-web/**/*
  - .gitlab-ci.yml
  - .gitlab/ci/apps/frontend-web.gitlab-ci.yaml

deploy:api-core:development:
  extends: .gitops-deploy
  needs:
    - job: build:api-core
      artifacts: true
  variables:
    APP_NAME: "api-core"
    GITOPS_ENVIRONMENT: "development"
    GITOPS_KUSTOMIZE_PATH: "kubernetes/clusters/bsn-main/public/bsn-resort-management-system/kustomize/overlays/review"
    NEW_IMAGE_TAG: "${API_CORE_IMAGE_TAG}"
  environment:
    name: development
    url: https://development.rms.bellsoft.net/
  rules:
    - if: "$REVIEW_DISABLED"
      when: never
    - changes: *api-core-changes
#      when: manual  # TODO: ÏûÑÏãú ÏûêÎèô Î∞∞Ìè¨ Íµ¨ÏÑ±
      allow_failure: true

deploy:api-core:staging:
  extends: .gitops-deploy
  needs:
    - job: build:api-core
      artifacts: true
  variables:
    APP_NAME: "api-core"
    GITOPS_ENVIRONMENT: "staging"
    GITOPS_KUSTOMIZE_PATH: "kubernetes/clusters/bsn-main/public/bsn-resort-management-system/kustomize/overlays/staging"
    NEW_IMAGE_TAG: "${API_CORE_IMAGE_TAG}"
  environment:
    name: staging
    url: https://staging.rms.bellsoft.net/
  rules:
    - if: "$DEPLOY_DISABLED"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes: *api-core-changes
    - changes: *api-core-changes
#      when: manual  # TODO: ÏûÑÏãú ÏûêÎèô Î∞∞Ìè¨ Íµ¨ÏÑ±
      allow_failure: true

deploy:api-core:production:
  extends: .gitops-deploy
  needs:
    - job: build:api-core
      artifacts: true
  variables:
    APP_NAME: "api-core"
    GITOPS_ENVIRONMENT: "production"
    GITOPS_KUSTOMIZE_PATH: "kubernetes/clusters/bsn-main/public/bsn-resort-management-system/kustomize/overlays/production"
    NEW_IMAGE_TAG: "${API_CORE_IMAGE_TAG}"
  environment:
    name: production
    url: https://rms.bellsoft.net/
  rules:
    - if: "$DEPLOY_DISABLED"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes: *api-core-changes
      when: manual

# Frontend-web Î∞∞Ìè¨ Ïû°Îì§
deploy:frontend-web:development:
  extends: .gitops-deploy
  needs:
    - job: build:frontend-web
      artifacts: true
  variables:
    APP_NAME: "frontend-web"
    GITOPS_ENVIRONMENT: "development"
    GITOPS_KUSTOMIZE_PATH: "kubernetes/clusters/bsn-main/public/bsn-resort-management-system/kustomize/overlays/review"
    NEW_IMAGE_TAG: "${FRONTEND_IMAGE_TAG}"
  environment:
    name: development
    url: https://development.rms.bellsoft.net/
  rules:
    - if: "$REVIEW_DISABLED"
      when: never
    - changes: *frontend-changes
#      when: manual  # TODO: ÏûÑÏãú ÏûêÎèô Î∞∞Ìè¨ Íµ¨ÏÑ±
      allow_failure: true

deploy:frontend-web:staging:
  extends: .gitops-deploy
  needs:
    - job: build:frontend-web
      artifacts: true
  variables:
    APP_NAME: "frontend-web"
    GITOPS_ENVIRONMENT: "staging"
    GITOPS_KUSTOMIZE_PATH: "kubernetes/clusters/bsn-main/public/bsn-resort-management-system/kustomize/overlays/staging"
    NEW_IMAGE_TAG: "${FRONTEND_IMAGE_TAG}"
  environment:
    name: staging
    url: https://staging.rms.bellsoft.net/
  rules:
    - if: "$DEPLOY_DISABLED"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes: *frontend-changes
    - changes: *frontend-changes
#      when: manual  # TODO: ÏûÑÏãú ÏûêÎèô Î∞∞Ìè¨ Íµ¨ÏÑ±
      allow_failure: true

deploy:frontend-web:production:
  extends: .gitops-deploy
  needs:
    - job: build:frontend-web
      artifacts: true
  variables:
    APP_NAME: "frontend-web"
    GITOPS_ENVIRONMENT: "production"
    GITOPS_KUSTOMIZE_PATH: "kubernetes/clusters/bsn-main/public/bsn-resort-management-system/kustomize/overlays/production"
    NEW_IMAGE_TAG: "${FRONTEND_IMAGE_TAG}"
  environment:
    name: production
    url: https://rms.bellsoft.net/
  rules:
    - if: "$DEPLOY_DISABLED"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes: *frontend-changes
      when: manual
