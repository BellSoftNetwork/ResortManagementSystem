# api-core (Golang + Gin) CI/CD êµ¬ì„±

# Go ì „ìš© í™˜ê²½ ë³€ìˆ˜ (ì˜ì¡´ì„± ì„¤ì¹˜ì™€ í…ŒìŠ¤íŠ¸ì—ì„œ ê³µí†µ ì‚¬ìš©)
.go-build-vars: &go-build-vars
  CGO_ENABLED: "0"
  GOOS: linux
  GOARCH: amd64
  GOCACHE: /builds/resort-assistant/resort-management-system/.cache/go-mod

# api-core ì˜ì¡´ì„± ì„¤ì¹˜ ìž¡ (ìºì‹œ ìž¬ì‚¬ìš© ë° ì—…ë°ì´íŠ¸)
dependencies:api-core:
  stage: dependencies
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/golang:1.24-alpine
  extends:
    - .go-cache-with-fallback
  variables: *go-build-vars
  before_script:
    - apk add --no-cache git
    - cd apps/api-core
  script:
    - echo "Checking Go dependencies cache..."
    - |
      # go.mod ë˜ëŠ” go.sumì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if [ -d "/builds/resort-assistant/resort-management-system/.cache/go-mod" ] && [ -f "go.mod" ]; then
        echo "ðŸ“¦ Cache found, verifying dependencies..."
        go mod verify 2>/dev/null && CACHE_VALID=true || CACHE_VALID=false
        if [ "$CACHE_VALID" = "true" ]; then
          echo "âœ… Cache is valid, dependencies up to date"
        else
          echo "ðŸ”„ Cache invalid, downloading fresh dependencies..."
          go mod download
          go mod verify
        fi
      else
        echo "ðŸ“¥ No cache found, downloading dependencies..."
        go mod download
        go mod verify
      fi
  rules:
    - changes:
        - apps/api-core/go.mod
        - apps/api-core/go.sum
        - apps/api-core/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-core.gitlab-ci.yaml

# api-core í…ŒìŠ¤íŠ¸ ìž¡
test:api-core:
  stage: test
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/golang:1.24-alpine
  extends:
    - .go-cache-with-fallback
    - .allow-failure-temp
    - .db-services
    - .test-env-vars
  variables:
    # í…ŒìŠ¤íŠ¸ì—ì„œëŠ” SQLite ì‚¬ìš©ì„ ìœ„í•´ CGO í™œì„±í™”
    CGO_ENABLED: "1"
    GOOS: linux
    GOARCH: amd64
    GOCACHE: /builds/resort-assistant/resort-management-system/.cache/go-mod
    # api-core ì „ìš© í…ŒìŠ¤íŠ¸ í™˜ê²½ ë³€ìˆ˜
    JWT_SECRET: test-secret-key
    API_PROFILE: test
  needs:
    - job: dependencies:api-core
      optional: true
  before_script:
    # CGO ì»´íŒŒì¼ì„ ìœ„í•œ í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - apk add --no-cache git gcc musl-dev
    - cd apps/api-core
    - go mod download
  script:
    - echo "Running api-core tests..."
    - go test ./... -v -coverprofile=coverage.out
    - go tool cover -html=coverage.out -o coverage.html
    - echo "Running api-core lint..."
    - go vet ./...
    - gofmt -d .
  coverage: '/Total coverage: (\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: apps/api-core/coverage.xml
    paths:
      - apps/api-core/coverage.out
      - apps/api-core/coverage.html
    expire_in: 1 week
  rules:
    - if: "$TEST_DISABLED"
      when: never
    - changes:
        - apps/api-core/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-core.gitlab-ci.yaml

# api-core ë¹Œë“œ ìž¡
build:api-core:
  extends:
    - .docker-build-base
    - .go-cache-with-fallback
  variables:
    IMAGE_REGISTRY: $API_CORE_IMAGE
  script:
    - echo "Building api-core Docker image..."
    - cd apps/api-core
    # ë¸Œëžœì¹˜ë³„ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
    - |
      # GitLab CI ì‚¬ì „ ì •ì˜ ë³€ìˆ˜ ì‚¬ìš© (ë¸Œëžœì¹˜ëª… ì •ê·œí™”)
      BRANCH_NAME=$(echo "$CI_COMMIT_REF_SLUG" | sed 's/\//-/g')

      # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      IMAGE_TAG="${BRANCH_NAME}-${CI_COMMIT_SHORT_SHA}"
      IMAGE_TAG_LATEST="${IMAGE_REGISTRY}:${IMAGE_TAG}"
      IMAGE_TAG_BRANCH_LATEST="${IMAGE_REGISTRY}:${BRANCH_NAME}-latest"
    # ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - echo "Building Docker image..."
    # ì´ì „ ë¸Œëžœì¹˜ ì´ë¯¸ì§€ pull ì‹œë„ (ìºì‹œë¡œ í™œìš©)
    - docker pull $IMAGE_TAG_BRANCH_LATEST || true
    - docker build --platform=linux/amd64 --cache-from $IMAGE_TAG_BRANCH_LATEST --build-arg BUILDKIT_INLINE_CACHE=1 -t $IMAGE_TAG_LATEST -t $IMAGE_TAG_BRANCH_LATEST .
    - docker push $IMAGE_TAG_LATEST
    - docker push $IMAGE_TAG_BRANCH_LATEST
    # ë¹Œë“œ ì •ë³´ ì €ìž¥ (ë°°í¬ jobì—ì„œ ì‚¬ìš©)
    - echo "API_CORE_IMAGE_TAG=${IMAGE_TAG}" > build.env
    - echo "API_CORE_IMAGE_FULL_TAG=${IMAGE_TAG_LATEST}" >> build.env
    - echo "API_CORE_IMAGE_BRANCH_TAG=${IMAGE_TAG_BRANCH_LATEST}" >> build.env
  artifacts:
    reports:
      dotenv: apps/api-core/build.env
  needs:
    - job: dependencies:api-core
      optional: true
  rules:
    - if: "$BUILD_DISABLED"
      when: never
    - changes:
        - apps/api-core/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-core.gitlab-ci.yaml
