# frontend-web (Vue.js/Quasar) CI/CD êµ¬ì„±

# í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸ í™˜ê²½ ë³€ìˆ˜
.frontend-test-vars: &frontend-test-vars
  variables:
    NODE_ENV: test

# frontend-web ì˜ì¡´ì„± ì„¤ì¹˜ ìž¡ (ìºì‹œ ìž¬ì‚¬ìš© ë° ì—…ë°ì´íŠ¸)
dependencies:frontend-web:
  stage: dependencies
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/node:$NODE_VERSION-alpine
  extends:
    - .node-cache-with-fallback
  before_script:
    - cd apps/frontend-web
  script:
    - echo "Checking Node.js dependencies cache..."
    - |
      # yarn.lockì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ìºì‹œ ìœ íš¨ì„± ê²€ì‚¬
      if [ -d "node_modules" ] && [ -f "yarn.lock" ]; then
        echo "ðŸ“¦ Cache found, verifying dependencies..."
        yarn check --verify-tree 2>/dev/null && CACHE_VALID=true || CACHE_VALID=false
        if [ "$CACHE_VALID" = "true" ]; then
          echo "âœ… Cache is valid, dependencies up to date"
        else
          echo "ðŸ”„ Cache invalid or outdated, installing fresh dependencies..."
          yarn install --frozen-lockfile
        fi
      else
        echo "ðŸ“¥ No cache found, installing dependencies..."
        yarn install --frozen-lockfile
      fi
  rules:
    - changes:
        - apps/frontend-web/package.json
        - apps/frontend-web/yarn.lock
        - apps/frontend-web/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/frontend-web.gitlab-ci.yaml

# frontend-web í…ŒìŠ¤íŠ¸ ìž¡
test:frontend-web:
  stage: test
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/node:$NODE_VERSION-alpine
  extends:
    - .node-cache-with-fallback
    - .allow-failure-temp
  <<: *frontend-test-vars
  needs:
    - job: dependencies:frontend-web
      optional: true
  before_script:
    - cd apps/frontend-web
    - yarn install --frozen-lockfile
  script:
    - echo "Running frontend-web tests..."
    - yarn lint:prettier  # prettier ê²€ì‚¬
    - yarn test:unit:coverage  # ìœ ë‹› í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€
    - yarn build  # ë¹Œë“œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: apps/frontend-web/coverage/cobertura-coverage.xml
    paths:
      - apps/frontend-web/coverage/
      - apps/frontend-web/dist/
    expire_in: 1 week
  rules:
    - if: "$TEST_DISABLED"
      when: never
    - changes:
        - apps/frontend-web/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/frontend-web.gitlab-ci.yaml

# frontend-web ë¹Œë“œ ìž¡
build:frontend-web:
  extends:
    - .docker-build-base
    - .node-cache-with-fallback
  variables:
    IMAGE_REGISTRY: $FRONTEND_IMAGE
  script:
    - echo "Building frontend-web Docker image..."
    - cd apps/frontend-web
    # ë¸Œëžœì¹˜ë³„ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
    - |
      # GitLab CI ì‚¬ì „ ì •ì˜ ë³€ìˆ˜ ì‚¬ìš© (ë¸Œëžœì¹˜ëª… ì •ê·œí™”)
      BRANCH_NAME=$(echo "$CI_COMMIT_REF_SLUG" | sed 's/\//-/g')

      # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      IMAGE_TAG="${BRANCH_NAME}-${CI_COMMIT_SHORT_SHA}"
      IMAGE_TAG_LATEST="${IMAGE_REGISTRY}:${IMAGE_TAG}"
      IMAGE_TAG_BRANCH_LATEST="${IMAGE_REGISTRY}:${BRANCH_NAME}-latest"
    # ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - echo "Building Docker image..."
    # ì´ì „ ë¸Œëžœì¹˜ ì´ë¯¸ì§€ pull ì‹œë„ (ìºì‹œë¡œ í™œìš©)
    - docker pull $IMAGE_TAG_BRANCH_LATEST || true
    - docker build --platform=linux/amd64 --cache-from $IMAGE_TAG_BRANCH_LATEST --build-arg BUILDKIT_INLINE_CACHE=1 -t $IMAGE_TAG_LATEST -t $IMAGE_TAG_BRANCH_LATEST .
    - docker push $IMAGE_TAG_LATEST
    - docker push $IMAGE_TAG_BRANCH_LATEST
    # ë¹Œë“œ ì •ë³´ ì €ìž¥
    - echo "FRONTEND_IMAGE_TAG=${IMAGE_TAG}" > build.env
  artifacts:
    reports:
      dotenv: apps/frontend-web/build.env
  needs:
    - job: dependencies:frontend-web
      optional: true
  rules:
    - if: "$BUILD_DISABLED"
      when: never
    - changes:
        - apps/frontend-web/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/frontend-web.gitlab-ci.yaml
