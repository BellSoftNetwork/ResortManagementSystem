# api-legacy (Kotlin Spring Boot) CI/CD êµ¬ì„±


# api-legacy ì˜ì¡´ì„± ì„¤ì¹˜ ì¡ (ìºì‹œ ì¬ì‚¬ìš© ë° ì—…ë°ì´íŠ¸)
dependencies:api-legacy:
  stage: dependencies
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/gradle:$GRADLE_VERSION
  extends:
    - .gradle-cache-with-fallback
  before_script:
    - chmod +x ./gradlew
  script:
    - echo "Checking Gradle dependencies cache..."
    - |
      # build.gradle.kts ë˜ëŠ” gradle.propertiesê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if [ -d ".gradle/caches" ] && [ -f "apps/api-legacy/build.gradle.kts" ]; then
        echo "ğŸ“¦ Cache found, checking if dependencies are up to date..."
        ./gradlew :apps:api-legacy:dependencies --dry-run >/dev/null 2>&1 && CACHE_VALID=true || CACHE_VALID=false
        if [ "$CACHE_VALID" = "true" ]; then
          echo "âœ… Cache is valid, dependencies up to date"
        else
          echo "ğŸ”„ Cache invalid or dependencies changed, downloading fresh dependencies..."
          ./gradlew :apps:api-legacy:dependencies
          ./gradlew :apps:api-legacy:testClasses
        fi
      else
        echo "ğŸ“¥ No cache found, downloading dependencies..."
        ./gradlew :apps:api-legacy:dependencies
        ./gradlew :apps:api-legacy:testClasses
      fi
  rules:
    - when: never  # api-legacy ì¡ ìŠ¤í‚µ
    - changes:
        - apps/api-legacy/build.gradle.kts
        - apps/api-legacy/gradle.properties
        - gradle.properties
        - apps/api-legacy/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-legacy.gitlab-ci.yaml

# api-legacy í…ŒìŠ¤íŠ¸ ì¡
test:api-legacy:
  stage: test
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/gradle:$GRADLE_VERSION
  extends:
    - .gradle-cache-with-fallback
    - .allow-failure-temp
    - .db-services
    - .test-env-vars
  variables:
    # Spring Boot ì „ìš© í…ŒìŠ¤íŠ¸ í™˜ê²½ ë³€ìˆ˜
    SPRING_PROFILES_ACTIVE: test
  needs:
    - job: dependencies:api-legacy
      optional: true
  before_script:
    - chmod +x ./gradlew
  script:
    - echo "Running api-legacy tests..."
    - ./gradlew :apps:api-legacy:clean :apps:api-legacy:test :apps:api-legacy:jacocoTestReport
    - ./gradlew :apps:api-legacy:ktlintCheck
  after_script:
    - cd apps/api-legacy
    # JaCoCo ë¦¬í¬íŠ¸ë¥¼ Cobertura í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    - |
      awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' build/reports/jacoco/test/jacocoTestReport.csv || true
  coverage: '/(\d+\.?\d*) % covered/'
  artifacts:
    reports:
      junit:
        - apps/api-legacy/build/test-results/test/**/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: apps/api-legacy/build/reports/jacoco/test/jacocoTestReport.xml
    paths:
      - apps/api-legacy/build/reports/
    expire_in: 1 week
  rules:
    - when: never  # api-legacy ì¡ ìŠ¤í‚µ
    - if: "$TEST_DISABLED"
      when: never
    - changes:
        - apps/api-legacy/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-legacy.gitlab-ci.yaml

# api-legacy ë¹Œë“œ ì¡
build:api-legacy:
  extends:
    - .docker-build-base
    - .gradle-cache-with-fallback
  variables:
    IMAGE_REGISTRY: $API_LEGACY_IMAGE
  script:
    - echo "Building api-legacy Docker image..."
    - cd apps/api-legacy
    # ë¸Œëœì¹˜ë³„ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
    - |
      # GitLab CI ì‚¬ì „ ì •ì˜ ë³€ìˆ˜ ì‚¬ìš© (ë¸Œëœì¹˜ëª… ì •ê·œí™”)
      BRANCH_NAME=$(echo "$CI_COMMIT_REF_SLUG" | sed 's/\//-/g')
      
      # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      IMAGE_TAG="${BRANCH_NAME}-${CI_COMMIT_SHORT_SHA}"
      IMAGE_TAG_LATEST="${IMAGE_REGISTRY}:${IMAGE_TAG}"
      IMAGE_TAG_BRANCH_LATEST="${IMAGE_REGISTRY}:${BRANCH_NAME}-latest"
    # ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - echo "Building Docker image..."
    - docker build --platform=linux/amd64 -t $IMAGE_TAG_LATEST -t $IMAGE_TAG_BRANCH_LATEST .
    - docker push $IMAGE_TAG_LATEST
    - docker push $IMAGE_TAG_BRANCH_LATEST
    # ë¹Œë“œ ì •ë³´ ì €ì¥
    - echo "API_LEGACY_IMAGE_TAG=$IMAGE_TAG_LATEST" > build.env
    - echo "API_LEGACY_IMAGE_TAG_COMMIT=$IMAGE_TAG_BRANCH_LATEST" >> build.env
  artifacts:
    reports:
      dotenv: apps/api-legacy/build.env
  needs:
    - job: dependencies:api-legacy
      optional: true
    - job: test:api-legacy
      optional: true
  rules:
    - when: never  # api-legacy ì¡ ìŠ¤í‚µ
    - if: "$BUILD_DISABLED"
      when: never
    - changes:
        - apps/api-legacy/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-legacy.gitlab-ci.yaml

# api-legacy Spring Boot ì´ë¯¸ì§€ ë¹Œë“œ (Gradle buildBootImage ì‚¬ìš©)
build:api-legacy:gradle:
  stage: build
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/gradle:$GRADLE_VERSION
  services:
    - ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - cd apps/api-legacy
    - |
      # Docker ì¸ì¦ì„œ ëŒ€ê¸°
      until [ -f $DOCKER_CERT_PATH/ca.pem ]; do
        echo "Waiting for Docker certificates..."
        sleep 1
      done
  script:
    - echo "Building api-legacy using Gradle bootBuildImage..."
    # ë¸Œëœì¹˜ë³„ íƒœê·¸ ìƒì„±
    - |
      # GitLab CI ì‚¬ì „ ì •ì˜ ë³€ìˆ˜ ì‚¬ìš© (ë¸Œëœì¹˜ëª… ì •ê·œí™”)
      BRANCH_NAME=$(echo "$CI_COMMIT_REF_SLUG" | sed 's/\//-/g')
      
      IMAGE_NAME="$API_LEGACY_IMAGE/$BRANCH_NAME:gradle-$CI_COMMIT_SHORT_SHA"
    # Gradleë¡œ ì´ë¯¸ì§€ ë¹Œë“œ
    - ./gradlew :apps:api-legacy:bootBuildImage --imageName=$IMAGE_NAME
    # ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ í‘¸ì‹œ
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $IMAGE_NAME
  rules:
    - when: never  # api-legacy ì¡ ìŠ¤í‚µ
    - if: "$BUILD_DISABLED"
      when: never
    - changes:
        - apps/api-legacy/**/*
        - .gitlab-ci.yml
        - .gitlab/ci/apps/api-legacy.gitlab-ci.yaml
      when: manual